name: PR → build overlay → Kaizen smoke

on:
  pull_request:
  workflow_dispatch:

env:
  IMAGE_TAG: ${{ github.event.pull_request.head.sha || github.sha }}

jobs:
  kaizen-ci:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS (844) to invoke CodeBuild
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-session-token:     ${{ secrets.AWS_SESSION_TOKEN }}
          aws-region:            ${{ secrets.AWS_REGION }}

      - name: Kick off unified CodeBuild job
        id: cb
        run: |
          set -euo pipefail
          BUILD_ID=$(aws codebuild start-build \
            --project-name kaizen-poc \
            --source-version "${{ env.IMAGE_TAG }}" \
            --buildspec-override buildspec-full.yml \
            --environment-variables-override \
                name=IMAGE_TAG,value=${{ env.IMAGE_TAG }},type=PLAINTEXT \
                name=KAIZEN_CLI_S3,value=${{ secrets.KAIZEN_CLI_S3 }},type=PLAINTEXT \
                name=TP_SIZE,value=16,type=PLAINTEXT \
                # pass all the ECR / credential secrets you already have … \
                name=AWS_REGION,value=${{ secrets.AWS_REGION }},type=PLAINTEXT \
                name=ECR_REGISTRY,value=${{ secrets.ECR_REGISTRY }},type=PLAINTEXT \
                name=ECR_URI,value=${{ secrets.ECR_URI }},type=PLAINTEXT \
                name=ADMIN_AWS_ACCESS_KEY_ID,value=${{ secrets.AWS_ACCESS_KEY_ID }},type=PLAINTEXT \
                name=ADMIN_AWS_SECRET_ACCESS_KEY,value=${{ secrets.AWS_SECRET_ACCESS_KEY }},type=PLAINTEXT \
                name=ADMIN_AWS_SESSION_TOKEN,value=${{ secrets.AWS_SESSION_TOKEN }},type=PLAINTEXT \
                name=KAIZEN_REGION,value=${{ secrets.KAIZEN_REGION }},type=PLAINTEXT \
                name=KAIZEN_ECR_REGISTRY,value=${{ secrets.KAIZEN_ECR_REGISTRY }},type=PLAINTEXT \
                name=KAIZEN_ECR_URI,value=${{ secrets.KAIZEN_ECR_URI }},type=PLAINTEXT \
                name=KAIZEN_ACCESS_KEY_ID,value=${{ secrets.KAIZEN_ACCESS_KEY_ID }},type=PLAINTEXT \
                name=KAIZEN_SECRET_ACCESS_KEY,value=${{ secrets.KAIZEN_SECRET_ACCESS_KEY }},type=PLAINTEXT \
                name=KAIZEN_SESSION_TOKEN,value=${{ secrets.KAIZEN_SESSION_TOKEN }},type=PLAINTEXT \
            --query 'build.id' --output text)
          echo "build_id=$BUILD_ID" >> "$GITHUB_OUTPUT"

      - name: Stream CodeBuild status → PR
        env:
          BUILD_ID:   ${{ steps.cb.outputs.build_id }}
          AWS_REGION: ${{ secrets.AWS_REGION }}
        run: |
          set -euo pipefail
          while true; do
            STATUS=$(aws codebuild batch-get-builds --ids "$BUILD_ID" \
              --query 'builds[0].buildStatus' --output text)
            echo "CodeBuild: $STATUS"
            case "$STATUS" in
              SUCCEEDED) exit 0;;
              FAILED|FAULT|STOPPED|TIMED_OUT)
                echo "❌ CodeBuild failed ($STATUS)"; exit 1;;
              IN_PROGRESS) sleep 20;;
            esac
          done
